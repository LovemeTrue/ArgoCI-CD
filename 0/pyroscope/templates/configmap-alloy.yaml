{{- if and (.Values.alloy.enabled) (not .Values.alloy.alloy.configMap.create)  }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.alloy.alloy.configMap.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pyroscope.labels" . | nindent 4 }}
data:
  config.alloy: |
		logging {
			level = "info"
		}

		discovery.kubernetes "pods" {
			role = "pod"
		}

		discovery.relabel "elma" {
			targets = discovery.kubernetes.pods.targets

			# только нужные неймспейсы
			rule {
				source_labels = ["__meta_kubernetes_namespace"]
				regex         = "elma365|elma365-dbs"
				action        = "keep"
			}

			# только поды с label app
			rule {
				source_labels = ["__meta_kubernetes_pod_label_app"]
				regex         = ".*"
				action        = "keep"
			}

			# только контейнеры с нужными портами
			rule {
				source_labels = ["__meta_kubernetes_pod_container_port_number"]
				regex         = "3000|4000|5000"
				action        = "keep"
			}

			# Добавляем параметры запроса профилей
			rule {
				target_label  = "__param_profile_type"
				replacement   = "cpu"
				action        = "replace"
			}

			rule {
				target_label  = "__param_path"
				replacement   = "/debug/pprof/profile"
				action        = "replace"
			}

			rule {
				target_label  = "__param_port"
				source_labels = ["__meta_kubernetes_pod_container_port_number"]
				action        = "replace"
			}

			rule {
				source_labels = ["__address__", "__param_port"]
				separator     = ":"
				target_label  = "__address__"
				action        = "replace"
				replacement   = "$1:$2"
			}

			# Дополнительные метки
			rule {
				source_labels = ["__meta_kubernetes_namespace"]
				target_label  = "namespace"
				action        = "replace"
			}

			rule {
				source_labels = ["__meta_kubernetes_pod_name"]
				target_label  = "pod"
				action        = "replace"
			}

			rule {
				source_labels = ["__meta_kubernetes_pod_container_name"]
				target_label  = "container"
				action        = "replace"
			}
		}

		profiling.scrape "cpu_profiles" {
			targets     = discovery.relabel.elma.output
			forward_to  = [profiling.write.to_pyro.receiver]

			profiling_config {
				profile.process_cpu {
					enabled = true
				}
				profile.heap {
					enabled = true
				}
				profile.goroutine {
					enabled = true
				}
			}
		}

		profiling.write "to_pyro" {
			endpoint {
				url = "http://pyroscope.pyroscope.svc.cluster.local:4040"
			}
		}
  {{- $profileTypes := list "memory" "cpu" "goroutine" "block" "mutex" "fgprof" }}
  {{- range $profileTypes }}

    discovery.relabel "kubernetes_pods_{{.}}_default_name" {
    	targets = concat(discovery.relabel.kubernetes_pods.output)

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_scrape"]
    		action        = "keep"
    		regex         = "true"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port_name"]
    		action        = "keep"
    		regex         = ""
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_container_port_number"]
    		target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port"
    		action        = "keepequal"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_scheme"]
    		action        = "replace"
    		regex         = "(https?)"
    		target_label  = "__scheme__"
    		replacement   = "$1"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_path"]
    		action        = "replace"
    		regex         = "(.+)"
    		target_label  = "__profile_path__"
    		replacement   = "$1"
    	}

    	rule {
    		source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port"]
    		action        = "replace"
    		regex         = "(.+?)(?::\\d+)?;(\\d+)"
    		target_label  = "__address__"
    		replacement   = "$1:$2"
    	}
    }

    discovery.relabel "kubernetes_pods_{{.}}_custom_name" {
    	targets = concat(discovery.relabel.kubernetes_pods.output)

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_scrape"]
    		action        = "keep"
    		regex         = "true"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port_name"]
    		action        = "drop"
    		regex         = ""
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_container_port_name"]
    		target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port_name"
    		action        = "keepequal"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_scheme"]
    		action        = "replace"
    		regex         = "(https?)"
    		target_label  = "__scheme__"
    		replacement   = "$1"
    	}

    	rule {
    		source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_path"]
    		action        = "replace"
    		regex         = "(.+)"
    		target_label  = "__profile_path__"
    		replacement   = "$1"
    	}

    	rule {
    		source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_{{.}}_port"]
    		action        = "replace"
    		regex         = "(.+?)(?::\\d+)?;(\\d+)"
    		target_label  = "__address__"
    		replacement   = "$1:$2"
    	}
    }

    pyroscope.scrape "pyroscope_scrape_{{.}}" {
    	clustering {
    		enabled = true
    	}

    	targets    = concat(discovery.relabel.kubernetes_pods_{{.}}_default_name.output, discovery.relabel.kubernetes_pods_{{.}}_custom_name.output)
    	forward_to = [pyroscope.write.pyroscope_write.receiver]

    	profiling_config {
        {{- $currentType := . -}}
        {{- range $profileTypes }}
    		profile.{{if eq . "cpu"}}process_cpu{{else}}{{.}}{{end}} {
    			enabled = {{if eq . $currentType}}true{{else}}false{{end}}
    		}
        {{- if ne . (last $profileTypes) }}{{ printf "\n" }}{{ end }}
        {{- end }}
    	}
    }
  {{- end }}

    pyroscope.write "pyroscope_write" {
    	endpoint {
        {{- if hasKey .Values.pyroscope.components "distributor" }}
    		url = "http://{{ include "pyroscope.fullname" . }}-distributor.{{ .Release.Namespace }}.svc{{ .Values.pyroscope.cluster_domain }}:{{ (.Values.pyroscope.components.distributor.service).port | default .Values.pyroscope.service.port}}"
        {{- else }}
    		url = "http://{{ include "pyroscope.fullname" . }}.{{ .Release.Namespace }}.svc{{ .Values.pyroscope.cluster_domain }}:{{ .Values.pyroscope.service.port }}"
        {{- end }}
    	}
    }

{{- end }}
